{% extends 'admin/master.html' %}

{% block body %}
    <table class="table">
        <tr>
        <th class="col-1">Run</th>
        <th class="col-1">Enabled</th>
        <th>Job</th>
        <th>When</th>
        </tr>
    {% for job in jobs %}
        <tr>
        <td class="col-1">
            <button class="btn btn-primary orc-runner" data-id="{{ job.id }}">&nbsp;</button>
        </td>
        <td class="col-1">
            <div class="form-group">
               <div class="custom-control custom-switch">
                 <input type="checkbox" class="custom-control-input orc-enable" data-id="{{ job.id }}" id="enable-{{ job.id }}" {{ 'checked' if job.next_run_time else ''}}>
                 <label class="custom-control-label" for="enable-{{ job.id }}"></label>
               </div>
             </div>
        </td>
        <td>{{ job.name }}</td>
        <td>{{ job.trigger.run_date.date().strftime("%m/%d") }} {{ job.trigger.run_date.time().strftime("%I:%M %p") }}</td>
        </tr>
    {% endfor %}
    </table>
{% endblock %}

{% block menu_links %}
<div class="nav ml-auto flex flex-column">
    <form>
        <select class="form-control orc-theme-select">
            <option value="">default</option>
            <option value="away">away</option>
            <option value="babysitter">babysitter</option>
        </select>
        <div class="orc-theme-schedule" style="position: absolute; visibility: hidden;">
            <div><input type="date" value="start" class="form-control orc-theme-select-start"/></div>
            <div><input type="date" value="end" class="form-control orc-theme-select-end"/></div>
        </div>
    </form>
</div>
{% endblock %}

{% block tail %}
    <script>
        let version = "{{ version }}";
        async function _call(url, el, onSuccess = () => {}, onFailure = () => {}) {
            el.disabled = true;
            let response = null;

            try {
                response = await fetch(url, {headers: { "orc-version": version }});
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }
                version = (await response.json()).version;
                return true;
            } catch (error) {
                if (response && response.status === 412) {
                    location.reload();
                }
                console.error(error.message);
                return false;
            } finally {
                el.disabled = false;
            }
        }

        async function run(el) { _call(`/${el.dataset.id}/run`, el); }

        async function pause(el) {
            const newStatus = el.checked;

            if (!await _call(`/${el.dataset.id}/pause`, el)) {
                el.checked = !newStatus;
            }
        }

        document.querySelectorAll(".orc-runner").forEach(el => { el.addEventListener("click", e => run(e.currentTarget)); });
        document.querySelectorAll(".orc-enable").forEach(el => { el.addEventListener("change", e => pause(e.currentTarget)); });

        document.querySelectorAll(".orc-theme-select").forEach(el => {
            el.addEventListener("change", e => {
                document.querySelectorAll(".orc-theme-schedule").forEach(schedule => {
                    schedule.style.visibility = e.target.value === "" ? "hidden" : "visible";
                });
            });
        });

        document.querySelectorAll(".orc-theme-select-start").forEach(startEl => {
            startEl.min = new Date().toISOString().split("T")[0];

            startEl.addEventListener("change", e => {
                const endEl = document.querySelector(".orc-theme-select-end");
                endEl.value = "";

                if (e.target.value) {
                    endEl.disabled = false;
                    endEl.min = e.target.value;
                } else {
                    endEl.disabled = true;
                }
            });
        });

    </script>
{% endblock %}
