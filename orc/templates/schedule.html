{% extends 'admin/master.html' %}

{% block head_css %}
    {{ super() }}
    <style>
        div#admin-navbar-collapse {
            align-items: baseline; 
            height: 2lh;
        }
        div#orc-theme-form {
            overflow: visible;
        }
        div#orc-theme-form-elements {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            background-color: transparent;
        }
        div.orc-theme-form-date-input {
            grid-column-start: 2;
            grid-column-end: 4;
        }
    </style>
{% endblock %}

{% block body %}
    <table class="table">
        <tr>
        <th class="col-1">Run</th>
        <th class="col-1">Enabled</th>
        <th>Job</th>
        <th>When</th>
        </tr>
    {% for job in jobs %}
        <tr>
        <td class="col-1">
            <button class="btn btn-primary orc-runner" data-id="{{ job.id }}">&nbsp;</button>
        </td>
        <td class="col-1">
            <div class="form-group">
               <div class="custom-control custom-switch">
                 <input type="checkbox" class="custom-control-input orc-enable" data-id="{{ job.id }}" id="enable-{{ job.id }}" {{ 'checked' if job.next_run_time else ''}}>
                 <label class="custom-control-label" for="enable-{{ job.id }}"></label>
               </div>
             </div>
        </td>
        <td>{{ job.name }}</td>
        <td>{{ job.trigger.run_date.date().strftime("%m/%d") }} {{ job.trigger.run_date.time().strftime("%I:%M %p") }}</td>
        </tr>
    {% endfor %}
    </table>
{% endblock %}

{% block menu_links %}
    <div class="nav">
        <form id="orc-theme-form" action="set_theme" method="POST">
            <div id="orc-theme-form-elements">
                <div>
                    <label for="orc-theme-select">Theme:</label>
                </div>
                <div>
                    <select name="theme" class="form-control orc-theme-changer" id="orc-theme-select">
                        <option value="">default</option>
                        <option value="away">away</option>
                        <option value="babysitter">babysitter</option>
                        <option value="home alone">home alone</option>
                        <option value="day off">day off</option>
                        <option value="work day">work day</option>
                    </select>
                </div>
                <div>
                    <input id="orc-theme-submit" type="submit" class="btn btn-primary" value="âŽ"/>
                </div>
                <div class="orc-theme-schedule"><label>Start</label></div>
                <div class="orc-theme-schedule orc-theme-form-date-input">
                    <input type="date" value="{{ theme.start }}" name="start" class="form-control orc-theme-changer" id="orc-theme-select-start"/>
                </div>
                <div class="orc-theme-schedule"><label>End</label></div>
                <div class="orc-theme-schedule orc-theme-form-date-input">
                    <input type="date" value="{{ theme.end }}" name="end" class="form-control orc-theme-changer" id="orc-theme-select-end"/>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block tail %}
    <script>
        let version = "{{ version }}";

        const startEl = document.querySelector("#orc-theme-select-start");
        const endEl = document.querySelector("#orc-theme-select-end");
        const selectEl = document.querySelector("#orc-theme-select");
        const scheduleEl = document.querySelectorAll(".orc-theme-schedule");
        const formEl = document.querySelector("#orc-theme-form");

        async function _call(url, el, onSuccess = () => {}, onFailure = () => {}) {
            el.disabled = true;
            let response = null;

            try {
                response = await fetch(url, {headers: { "orc-version": version }});
                if (!response.ok) {
                    throw Error(`Response status: ${response.status}`);
                }
                version = (await response.json()).version;
                return true;
            } catch (error) {
                console.error(error.message);
                if (response && response.status === 412) {
                    location.reload();
                }
                return false;
            } finally {
                el.disabled = false;
            }
        }

        async function run(el) { await _call(`${el.dataset.id}/run`, el); }
        async function pause(el) {
            const newStatus = el.checked;

            if (!await _call(`${el.dataset.id}/pause`, el)) {
                el.checked = !newStatus;
            }
        }

        function date() {
            const now = new Date();
            return now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate();
        }

        function formUpdated() {
            document.querySelector("#orc-theme-submit").disabled = selectEl.value && !(startEl.value && endEl.value);
        }

        document.querySelectorAll(".orc-runner").forEach(el => { el.addEventListener("click", e => run(e.currentTarget)); });
        document.querySelectorAll(".orc-enable").forEach(el => { el.addEventListener("change", e => pause(e.currentTarget)); });

        document.querySelectorAll(".orc-theme-changer").forEach(el => { 
            el.addEventListener("change", e => { 
                formUpdated();
            });
        });

        selectEl.addEventListener("change", e => {
            scheduleEl.forEach(el => { el.style.visibility = e.target.value === "" ? "hidden" : "visible"; });
            formEl.style.backgroundColor = e.target.value === "" ? "transparent" : "black";
            if(e.target.value === "") {
                startEl.value = ""
                endEl.value = ""
            }
        });
        selectEl.value = "{{ theme.name }}";
        selectEl.dispatchEvent(new Event("change"));

        startEl.min = date();
        startEl.addEventListener("change", e => {
            if (e.target.value) {
                endEl.disabled = false;
                endEl.value = endEl.min = e.target.value;
            } else {
                endEl.disabled = true;
                endEl.value = null;
            }
            formUpdated();
        });
    </script>
{% endblock %}
